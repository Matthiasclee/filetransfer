#!/usr/bin/env ruby
require "filetransfer"
require "socket"

originalpath = ARGV[0] || `zenity --file-selection --title='Send File'`.chomp
exit(1) if $?.exitstatus == 1

path = originalpath.gsub(" ", "`")
name = originalpath.split("/").last.gsub(" ", "_")

recipient = ""
loop do
  recipient = ARGV[1] || `zenity --text="Recipient\\nLeave blank to discover available recipients" --entry --title='Send File'`.chomp
  exit(1) if $?.exitstatus == 1

  if recipient == ""
    hosts = `nmap -Pn -p8021 --open 192.168.0.0/24 | grep -oP '([\\w-]+\\s\\(((25[0-5]|(2[0-4]|1\\d|[1-9]|)\\d)\\.?\\b){4}\\)|((25[0-5]|(2[0-4]|1\\d|[1-9]|)\\d)\\.?\\b){4})'`
    `zenity --info --no-wrap --title="Avalable recipients" --text="#{hosts}"`
  else
    break
  end
end

server = TCPSocket.new("127.0.0.1", 8021)
server.puts "FTSUBMIT #{name} #{path}"
fileid = server.gets

file_size = '%.2f' % (File.size(originalpath).to_f / 2**20)

server = TCPSocket.new(recipient, 8021)
server.puts "FTSEND #{name.gsub(" ", "_")} #{file_size}MB #{fileid}"

exit
